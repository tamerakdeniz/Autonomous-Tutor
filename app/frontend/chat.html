<!DOCTYPE html>
<html>
  <head>
    <title>AI Tutor Chat</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body class="d-flex flex-column vh-100">
    <nav class="navbar navbar-light bg-light">
      <span class="navbar-brand mb-0 h1">Decentralized Tutor</span>
    </nav>

    <div id="chat" class="flex-grow-1 overflow-auto p-3"></div>

    <div class="input-area p-3 bg-white">
      <div class="input-group">
        <input
          type="text"
          id="message"
          class="form-control"
          placeholder="Type your message..."
        />
        <div class="input-group-append">
          <button onclick="sendMessage()" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>

    <script>
      function createMessageBubble(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);

        if (sender === 'bot') {
          const html = marked.parse(text);

          // Kod bloklarını sar ve kopyalama butonu ekle
          const processed = html.replace(
            /<pre(?:><code>)?([\s\S]*?)(?:<\/code>)?<\/pre>/g,
            (match, codeContent) => {
              const lines = codeContent
                .split('\n')
                .map(line => `<span>${line}</span>`)
                .join('');
              return `
				 <div class="code-container">
					  <button class="copy-button" onclick="copyCode(this)">Copy</button>
					  <pre><code>${lines}</code></pre>
				 </div>`;
            }
          );

          messageDiv.innerHTML = processed;
        } else {
          messageDiv.innerText = text;
        }

        document.getElementById('chat').appendChild(messageDiv);
        document.getElementById('chat').scrollTop =
          document.getElementById('chat').scrollHeight;
      }

      function sendMessage() {
        const username = localStorage.getItem('username');
        const message = document.getElementById('message').value;

        if (!message.trim()) return;

        createMessageBubble(message, 'user');

        fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, message })
        })
          .then(res => res.json())
          .then(data => {
            createMessageBubble(data.response, 'bot');
            document.getElementById('message').value = '';
          });
      }

      function copyCode(button) {
        const container = button.parentElement;
        const code = container.querySelectorAll('code span');
        const text = Array.from(code)
          .map(span => span.innerText)
          .join('\n');

        navigator.clipboard.writeText(text).then(() => {
          // Copied animasyonu
          button.classList.add('copied');
          container.classList.add('highlight');

          setTimeout(() => {
            button.classList.remove('copied');
            container.classList.remove('highlight');
          }, 2000);
        });
      }

      const input = document.getElementById('message');
      input.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
